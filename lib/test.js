!function(t){var e={};function r(n){if(e[n])return e[n].exports;var i=e[n]={i:n,l:!1,exports:{}};return t[n].call(i.exports,i,i.exports,r),i.l=!0,i.exports}r.m=t,r.c=e,r.d=function(t,e,n){r.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:n})},r.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},r.t=function(t,e){if(1&e&&(t=r(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var n=Object.create(null);if(r.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var i in t)r.d(n,i,function(e){return t[e]}.bind(null,i));return n},r.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return r.d(e,"a",e),e},r.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},r.p="",r(r.s=5)}([function(t,e){t.exports=require("prosemirror-state")},function(t,e){t.exports=require("prosemirror-model")},function(t,e){t.exports=require("prosemirror-keymap")},function(t,e){t.exports=require("prosemirror-commands")},function(t,e){t.exports=require("prosemirror-transform")},function(t,e,r){"use strict";r.r(e);var n=new(r(1).Schema)({nodes:{text:{},block:{content:"text*",attrs:{visible:{default:!0},underline:{default:!1},bold:{default:!1},italic:{default:!1},strikethrough:{default:!1},color:{default:""},background:{default:""},tail:{default:""},head:{default:""}},toDOM:()=>["div",{class:"block"},0],parseDOM:[{tag:"div"}]},doc:{content:"block+"}}}),i=r(0);var o=class{constructor(t){this.reset(t),this.state=[]}reset(t){this.input=t,this.pos=0}next(){return this.input[this.pos++]}peek(){return this.input[this.pos]}eof(){return this.pos>=this.input.length}save(){this.state.push(this.pos)}restore(){this.pos=this.state.pop()}};var s=class{constructor(t){this.istream=t,this.current=null}readWhile(t){let e="";for(;!this.istream.eof()&&t(this.istream.peek());)e+=this.istream.next();return e}readEscapedString(t=!1){let e=!1,r="";for(;!this.istream.eof();){const n=this.istream.next();if(e)t&&(r+="\\"),r+=n,e=!1;else if("\\"===n)e=!0;else{if('"'===n)break;r+=n}}return r}readBacktickString(){let t="";for(;!this.istream.eof();){const e=this.istream.next();if("`"===e)break;t+=e}return t}next(){const t=this.current;return this.current=null,t||this.readNext()}peek(){return this.current||(this.current=this.readNext())}eof(){return null===this.peek()}};const a=t=>" "===t||"\t"===t,l=t=>-1!=="#_-abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ".indexOf(t),c=t=>!a(t)&&"|"!==t,h=t=>-1!=="0123456789.-".indexOf(t),u=t=>-1!=="+-*/^%".indexOf(t),p=t=>"("===t||")"===t,d=t=>-1!=="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789".indexOf(t),f=t=>"tag"===t.type,m=t=>"pipe"===t.type,g=t=>"["!==t&&"#"!==t&&"="!==t&&"{"!==t,b={empty:!0};class x extends s{constructor(t){super(t)}readString(){return{type:"string",value:this.readEscapedString()}}readTag(){return this.readWhile(l)}readCode(){let t="";for(;!this.istream.eof();){const e=this.istream.next();if(")"===e)return t;t+='"'===e?'"'+this.readEscapedString(!0)+'"':"`"===e?"`"+this.readBacktickString()+"`":e}return null}readTag(){const t={type:"tag",from:this.istream.pos,label:this.readWhile(l)};return":"===this.istream.peek()&&(this.istream.next(),t.value=this.readWhile(h)),t.to=this.istream.pos,t}readButton(){const t={type:"button",from:this.istream.pos};return this.istream.next(),this.istream.save(),t.label=this.readWhile(t=>"]"!==t),this.istream.eof()?(this.istream.restore(),b):(this.istream.next(),"("!==this.istream.peek()?b:(this.istream.next(),this.istream.save(),t.code=this.readCode(),t.code?(t.to=this.istream.pos,t):(this.istream.restore(),b)))}readImm(){const t={type:"imm",from:this.istream.pos};return this.istream.next(),"("!==this.istream.peek()?b:(this.istream.next(),this.istream.save(),t.code=this.readCode(),t.code?(t.to=this.istream.pos,t):(this.istream.restore(),b))}readText(){const t={type:"text",from:this.istream.pos};return this.istream.next(),t.labelFrom=this.istream.pos,this.istream.save(),t.label=this.readWhile(t=>"}"!==t),t.labelTo=this.istream.pos,this.istream.eof()?(this.istream.restore(),b):(this.istream.next(),t.codeFrom=this.istream.pos,"("!==this.istream.peek()?b:(this.istream.next(),this.istream.save(),t.code=this.readCode(),t.code?(t.to=this.istream.pos,t):(this.istream.restore(),b)))}readNext(){if(this.readWhile(g),this.istream.eof())return null;const t=this.istream.peek();return"#"===t?this.readTag():"["===t?this.readButton():"="===t?this.readImm():"{"===t?this.readText():null}}const k=t=>{const e=new o(t),r=new x(e),n=[];for(;!r.eof();){const t=r.next();t!==b&&n.push(t)}return n},y="|",v='"',w="#",S="`";class N extends s{constructor(t){super(t)}readBacktick(){const t=this.readBacktickString();return{type:"nested",value:A(t),code:t}}readString(){return{type:"string",value:this.readEscapedString()}}readTag(){return{type:"tag",value:this.readWhile(l)}}readIdent(){return{type:"ident",value:this.readWhile(c)}}readNum(){return{type:"number",value:this.readWhile(h)}}readNext(){if(this.readWhile(a),this.istream.eof())return null;const t=this.istream.peek();if(t===w)return this.readTag();if(t===y)return this.istream.next(),{type:"pipe"};if(t===v)return this.istream.next(),this.readString();if(t===S)return this.istream.next(),this.readBacktick();if(h(t))return this.readNum();if(c(t))return this.readIdent();throw new Error(`cannot handle char: ${t} at ${this.istream.pos}`)}}class E{constructor(t){this.tstream=t}readWhile(t){const e=[];for(;!this.tstream.eof()&&t(this.tstream.peek());)e.push(this.tstream.next());return e}readSelector(){return{type:"selector",values:this.readWhile(f)}}readArgs(){const t=[];let e=this.tstream.peek();for(;!this.tstream.eof()&&"pipe"!==e.type;)"tag"===e.type?t.push({type:"selector",values:this.readWhile(f).map(t=>t.value)}):t.push(this.tstream.next()),e=this.tstream.peek();return t}parseToken(){if(this.readWhile(m),this.tstream.eof())return;const t=this.tstream.peek();if("tag"===t.type)return{fn:"select",arguments:this.readArgs()};if("ident"===t.type)return this.tstream.next(),{fn:t.value,arguments:this.readArgs()};throw new Error(`unrecognized token (${t.value})`)}parse(){const t=[];for(;!this.tstream.eof();){const e=this.parseToken();e&&t.push(e)}return t}}const A=t=>{const e=new o(t),r=new N(e);return new E(r).parse()};r(2),r(3);const M=t=>{let e=0;for(;"\t"===t[e++];);return e-1};class O{constructor(){this.from=0,this.to=0,this.depth=0,this.size=0,this.parent=null,this.children=[],this.features=[]}addChild(t){this.children.push(t),t.parent=this}}var T=class{constructor(){this.reset(),this.lastError=null}reset(){this.index={},this.features=[],this.root=null}getLastError(){return this.lastError}recurseTree(t,e){for(let r=0;r<t.children.length;++r){const n=t.children[r];let i=e(n);if(!1===i)return!1;if(n.children&&n.children.length&&!1===(i=this.recurseTree(n,e)))return!1}}find(t){let e;return this.recurseTree(this.root,r=>{if(r.from===t)return e=r,!1}),e}build(t){this.reset();let e=new O,r=-1,n=[e];t.doc.descendants((t,e)=>{if(!t.isBlock)return;let i=t.textContent,o=M(i),s=new O;s.from=e,s.to=e+t.nodeSize,s.depth=o,s.size=t.nodeSize,k(t.textContent).forEach(t=>{if("tag"===t.type)this.index[t.label]||(this.index[t.label]=[]),-1===this.index[t.label].indexOf(s)&&this.index[t.label].push(s);else if("imm"===t.type||"text"===t.type)try{const e=A(t.code);t.ast=e}catch(t){this.lastError=t}t.from+=e+1,t.to+=e+1,t.blockFrom=s.from,t.block=s,this.features.push(t),s.features.push(t)}),o>r?(n[n.length-1].addChild(s),n.push(s),r=o):o==r?(n.pop(),n[n.length-1].addChild(s),n.push(s)):o<r&&(n[o].addChild(s),r=o,n.length=o+1,n.push(s))}),this.root=e}},C=r(4);class B{constructor(t,e,r,n,i,o){this.ast=t,this.blockFrom=e,this.currentState=r,this.meta=n,this.docStruct=i,this.functions=o,this.tr=r.tr,this.mapping=new C.Mapping,this.setMeta(this.tr),this.shouldUpdate=!1,this.ast.length&&"select"!==this.ast[0].fn&&"this"!==this.ast[0].fn&&this.ast.unshift({fn:"this",arguments:[]}),this.domAtPos=null}setMeta(t){Object.keys(this.meta).forEach(e=>{t.setMeta(e,this.meta[e])})}apply(){this.shouldUpdate=this.tr.docChanged||this.meta.forceUpdate,this.currentState=this.currentState.apply(this.tr),this.mapping.appendMapping(this.tr.mapping),this.blockFrom=this.tr.mapping.map(this.blockFrom),this.tr=this.currentState.tr,this.setMeta(this.tr),this.shouldUpdate&&this.docStruct.build(this.currentState)}executeStep(t,e){const r=this.functions[e.fn];if(!r)throw new Error(`unrecognised fn: ${e.fn}`);return r.call(this,t,e.arguments)}execute(){let t=0,e=[];try{for(;t<this.ast.length;)e=this.executeStep(e,this.ast[t]),this.apply(),t++}catch(t){this.docStruct.lastError=t}return e}executeNewContext(t,e){const r=new B(t,this.blockFrom,this.currentState,this.meta,this.docStruct,e),n=r.execute();return r.shouldUpdate&&(this.shouldUpdate=!0,this.blockFrom=r.mapping.map(this.blockFrom),this.mapping.appendMapping(r.mapping)),n}getLastError(){return this.lastError}setDomAtPos(t){this.domAtPos=t}}var W=B;class J{constructor(t,e){this.from=t,this.to=e,this.history=[]}toJSON(){return{from:this.from,to:this.to}}applyMapping(t){return this.history.push(this.toJSON()),this.from=t.map(this.from),this.to=t.map(this.to),this}static fromBlock(t){return new J(t.from,t.to)}}const $=(t,e)=>{let r=t.index[e[0]],n=1;for(r=r&&r.length?r.slice(0):[];n<e.length;){const i=t.index[e[n]]||[];r=r.filter(t=>-1!==i.indexOf(t)),n++}return r.map(t=>new J(t.from,t.to))},F=t=>Array.isArray(t),P=t=>"number"==typeof t,j=t=>"string"==typeof t,D=t=>P(t)||j(t),z=t=>t instanceof J,I=t=>!!F(t)&&t.every(z),q=t=>F(t)&&t.every(D),L=t=>q(t)||(t=>D(t))(t),R=t=>P(t),U=t=>F(t)&&t.every(P),_=t=>U(t)||R(t),G=t=>F(t)&&t.every(j),H=t=>F(t);class V extends Error{constructor(t,e){super(`${t}: input must be of type ${e=e||"blocks"}`)}}class Z extends Error{constructor(t,e){super(`${t}: ${e}`)}}const Q=(t,e)=>{t.children.forEach(t=>{e(t),t.children&&t.children.length&&Q(t,e)})},Y=t=>{const e={},r=[];return t.forEach(t=>{e[t.from]||(Q(t,t=>{e[t.from]=!0}),r.push(t))}),r},K=t=>t.filter((e,r)=>t.indexOf(e)===r),X=t=>{let e="";for(;t--;)e+="\t";return e},tt=(t,e,r)=>{const n=r&&t.endsWith(r)?t.substring(0,t.length-r.length):t;return e&&n.startsWith(e)?t.substr(e.length):t};var et=function(t,e){if(!I(t))throw new V("after");if(!e.length)throw new Z("after","argument must be a string");if("string"!==e[0].type)throw new Z("after","argument must be a string");t=K(t);const r=e[0].value,n=e[1]&&"ident"===e[1].type&&"once"===e[1].value;return t.forEach((t,e)=>{const o=this.docStruct.find(t.from),s=this.tr.doc.resolve(this.tr.mapping.map(t.from)).nodeAfter;if(!s||s.isText)return;const a=s.textContent.substr(o.depth),l=s.attrs.tail,c=this.tr.mapping.map(t.from)+s.textContent.length+1,h=tt(a,s.attrs.head,s.attrs.tail);if(!n||!l){if(l!==r){s.attrs.tail=r;const e={...s.attrs};e.tail=r,this.tr.setNodeMarkup(this.tr.mapping.map(t.from),null,e)}if(l&&h.length&&h.endsWith(l)&&l!==r)this.tr.insertText(r,c-l.length,c);else if(!h.endsWith(r)){const t=this.tr.selection;t.from===c&&t.empty?(this.tr.insertText(r,c),this.tr.setSelection(i.TextSelection.create(this.tr.doc,c))):this.tr.insertText(r,c)}}}),t.map(t=>t.applyMapping(this.tr.mapping))};const rt=(t,e,r)=>{const n=e&&t.startsWith(e)?t.substr(e.length):t;return r&&n.endsWith(r)?t.substring(0,t.length-r.length):t};var nt=function(t,e){if(!I(t))throw new V("before");if(!e.length)throw new Z("before","argument must be a string");if("string"!==e[0].type)throw new Z("before","argument must be a string");const r=e[1]&&"ident"===e[1].type&&"once"===e[1].value;t=K(t);const n=e[0].value;return t.forEach(t=>{const e=this.docStruct.find(t.from),i=this.tr.doc.resolve(this.tr.mapping.map(t.from)).nodeAfter;if(!i||i.isText)return;const o=i.textContent.substr(e.depth),s=i.attrs.head,a=this.tr.mapping.map(t.from)+e.depth+1,l=rt(o,i.attrs.head,i.attrs.tail);if(!r||!s){if(s!==n){i.attrs.head=n;const e={...i.attrs};e.head=n,this.tr.setNodeMarkup(this.tr.mapping.map(t.from),null,e)}s&&l.length&&l.startsWith(s)&&s!==n?this.tr.insertText(n,a,a+s.length):l.startsWith(n)||this.tr.insertText(n,a)}}),t.map(t=>t.applyMapping(this.tr.mapping))};var it=function(t,e){if(!I(t))throw new V("duplicate");const r=[];return t.forEach(t=>{const e=this.tr.doc.resolve(this.tr.mapping.map(t.from)).nodeAfter,n=this.tr.mapping.map(t.to);this.tr.insert(n,e),r.push(new J(n,n+e.nodeSize))}),r};var ot=function(t,e){if(!I(t))throw new V("flatten");return t.forEach(t=>{const e=this.docStruct.find(t.from);this.tr.insertText("",this.tr.mapping.map(t.from)+1,this.tr.mapping.map(t.from)+e.depth+1)}),t.map(t=>t.applyMapping(this.tr.mapping))};var st=function(t,e){if(!I(t))throw new V("hide");return t.forEach(t=>{const e=this.tr.doc.resolve(this.tr.mapping.map(t.from)).nodeAfter;if(e&&e.attrs.visible){const r={...e.attrs};r.visible=!1,this.tr.setNodeMarkup(this.tr.mapping.map(t.from),null,r)}}),t};var at=function(t,e){if(!I(t))throw new V("indent");return t.forEach(t=>{const e=this.docStruct.find(t.from);this.tr.insertText(X(e.depth+1),this.tr.mapping.map(t.from)+1,this.tr.mapping.map(t.from)+e.depth+1)}),t.map(t=>t.applyMapping(this.tr.mapping))};var lt=function(t,e){const r=[];return Q(this.docStruct.root,t=>{r.push(J.fromBlock(t))}),r};var ct=function(t,e){if(!I(t))throw new V("children");const r=e[0]&&"ident"===e[0].type&&"incl"===e[0].value,n=[];return t.forEach(e=>{const i=this.docStruct.find(e.from);i.children&&i.children.forEach(e=>{r?t.push(J.fromBlock(e)):n.push(J.fromBlock(e))})}),r?K(t):n};var ht=function(t,e){if(!I(t))throw new V("descendants");const r=e[0]&&"ident"===e[0].type&&"incl"===e[0].value,n=[];return t.forEach(e=>{const i=this.docStruct.find(e.from);Q(i,e=>{r?t.push(J.fromBlock(e)):n.push(J.fromBlock(e))})}),r?K(t):n};var ut=function(t,e){if(!I(t))throw new V("filter");if(!e.length)throw new Z("select","argument must have selector");if("selector"!==e[0].type&&"ident"!==e[0].type)throw new Z("select","argument must be selector or keyword");const r="selector"===e[0].type?"selector":e[0].value;return t.filter(t=>{const n=this.docStruct.find(t.from),i=this.tr.doc.resolve(this.tr.mapping.map(t.from)).nodeAfter;switch(r){case"visible":return i.attrs.visible;case"hidden":return!i.attrs.visible;case"empty":return 0===i.textContent.substr(n.depth).length;case"notempty":return i.textContent.substr(n.depth).length>0;case"plaintext":return 0===n.features.length;case"feature":return n.features.length>0;case"haschildren":return n.children.length>0;case"nochildren":return 0===n.children.length;case"hascolor":return""!==i.attrs.color;case"nocolor":return""===i.attrs.color;case"hasbackground":return""!==i.attrs.background;case"nobackground":return""===i.attrs.background;case"hashead":return""!==i.attrs.head;case"nohead":return""===i.attrs.head;case"hastail":return""!==i.attrs.tail;case"notail":return""===i.attrs.tail;case"selector":const t=e[0].values;return Boolean(n.features.find(e=>"tag"===e.type&&-1!==t.indexOf(e.label)))}return!1})};var pt=function(t,e){if(!I(t))throw new V("first");return[t[0]]};var dt=function(t,e){if(!I(t))throw new V("last");return t.length?[t[t.length-1]]:[]};var ft=function(t,e){if(!I(t))throw new V("next");let r=1;e[0]&&("number"===e[0].type?r=Number(e[0].value):"ident"===e[0].type&&"all"===e[0].value&&(r=1/0));let n=[];return t.forEach(t=>{const e=this.docStruct.find(t.from),i=e.parent.children.findIndex(t=>t===e);if(-1===i)return;const o=i+1;n=n.concat(e.parent.children.slice(o,o+r))}),K(n).map(t=>J.fromBlock(t))};var mt=function(t,e){if(!I(t))throw new V("not","block");if(!e.length)throw new Z("not","argument must be a selector or this");const r=e[0];let n;return"selector"===r.type?n=$(this.docStruct,r.values)||[]:"ident"===r.type&&"this"===r.value&&(n=[this.docStruct.find(this.blockFrom)]),t.filter(t=>-1===n.findIndex(e=>e.from===t.from))};var gt=function(t,e){if(!I(t))throw new V("parent");const r=e[0]&&"ident"===e[0].type&&"incl"===e[0].value,n=[];return t.forEach(e=>{const i=this.docStruct.find(e.from);i.parent!==this.docStruct.root&&(r?t.push(J.fromBlock(i.parent)):n.push(J.fromBlock(i.parent)))}),r?t:n};var bt=function(t,e){if(!I(t))throw new V("prev");let r=1;e[0]&&("number"===e[0].type?r=Number(e[0].value):"ident"===e[0].type&&"all"===e[0].value&&(r=1/0));let n=[];return t.forEach(t=>{const e=this.docStruct.find(t.from),i=e.parent.children.findIndex(t=>t===e);-1!==i&&(n=n.concat(e.parent.children.slice(i-r,i)))}),K(n).map(t=>J.fromBlock(t))};var xt=function(t,e){if(!e.length)throw new Z("select","argument must have selector");const r=e[0];if("selector"!==r.type)throw new Z("select","argument must be selector");if(t&&t.length){const e=$(this.docStruct,r.values)||[];return t.concat(e.filter(e=>-1===t.indexOf(e)))}return $(this.docStruct,r.values)||[]};var kt=function(t,e){if(!I(t))throw new V("siblings");const r=[];return t.forEach(t=>{const e=this.docStruct.find(t.from);e.parent&&e.parent.children.forEach(t=>{t!==e&&r.push(t)})}),K(r).map(t=>J.fromBlock(t))};var yt=function(t,e){if(!I(t))throw new V("slice");let r,n;if(2===e.length)r=Number(e[0].value),n=Number(e[1].value);else{if(1!==e.length)throw new Z("slice","argument must be: from to");r=Number(e[0].value),n=t.length}return r<0&&(r=t.length+r,n<0)?[]:n<0&&(n=t.length+n)<0?[]:t.slice(r,n)};var vt=function(t,e){return I(t)?(t.push(J.fromBlock(this.docStruct.find(this.blockFrom))),t):[J.fromBlock(this.docStruct.find(this.blockFrom))]};var wt={all:lt,children:ct,descendants:ht,filter:ut,first:pt,last:dt,next:ft,not:mt,parent:gt,prev:bt,select:xt,siblings:kt,slice:yt,this:vt,">":ct,"*":ht};var St=function(t,e){if(!I(t))throw new V("move");if(!e.length)throw new Z("move","argument requires destination selector");if("nested"!==e[0].type)throw new Z("move","argument requires destination as a backtick selector");const r=this.executeNewContext(e[0].value,wt);if(!r||!r.length||!I(r))return t;const n=this.docStruct.find(r[0].from);let i=n.to;const o=Y(t.map(t=>this.docStruct.find(t.from)));if(n.children.length){let t=n;do{i=t.to}while(t.children&&t.children.length&&(t=t.children[t.children.length-1]))}const s=[];o.forEach(t=>{const e=this.docStruct.find(t.from),r=n.depth-e.depth,i=this.tr.doc.resolve(this.tr.mapping.map(t.from)).nodeAfter;s.push({block:e,node:i,depthDiff:r,isRoot:!0}),this.tr.delete(this.tr.mapping.map(t.from),this.tr.mapping.map(t.to)),Q(e,t=>{const e=this.tr.doc.resolve(this.tr.mapping.map(t.from)).nodeAfter;s.push({block:t,node:e,depthDiff:r}),this.tr.delete(this.tr.mapping.map(t.from),this.tr.mapping.map(t.to))})});const a=[];let l=this.tr.mapping.map(i);return s.forEach(({block:t,node:e,depthDiff:r,isRoot:n})=>{this.tr.insert(l,e),this.tr.insertText(X(t.depth+r+1),l+1,l+t.depth+1),n&&a.push(new J(l,l+e.nodeSize)),l+=e.nodeSize+(r+1)}),a};var Nt=function(t,e){const r=this.docStruct.find(this.blockFrom);return r.parent.children.findIndex(t=>t===r)};var Et=function(t,e){if(!I(t))throw new V("remove");return t.forEach(t=>{this.tr.delete(this.tr.mapping.map(t.from),this.tr.mapping.map(t.to))}),[]};var At=function(t,e){if(!I(t))throw new V("show");return t.forEach(t=>{const e=this.tr.doc.resolve(this.tr.mapping.map(t.from)).nodeAfter;if(e&&!e.attrs.visible){const r={...e.attrs};r.visible=!0,this.tr.setNodeMarkup(this.tr.mapping.map(t.from),null,r)}}),t};var Mt=function(t,e){if(!I(t))throw new V("sort");const r=this.tr.selection.from;let n="alpha",o="asc";2===e.length?(n="selector"===e[0].type?e[0].values[0]:e[0].value,o="asc"===e[1].value||"desc"===e[1].value?e[1].value:"asc"):1===e.length&&(n="alpha",o="asc"===e[0].value||"desc"===e[0].value?e[0].value:"asc");const s="desc"===o?-1:1;return t.forEach(t=>{const e=this.docStruct.find(t.from),o=this.tr.mapping.map(t.to),a=[...e.children];if(a.sort((t,e)=>{const r=this.tr.doc.resolve(this.tr.mapping.map(t.from)).nodeAfter,i=this.tr.doc.resolve(this.tr.mapping.map(e.from)).nodeAfter,o=r.textContent.substr(t.depth),a=i.textContent.substr(e.depth);if("alpha"!==n){const r=t.features.find(t=>t.label===n),i=e.features.find(t=>t.label===n);return(Number(r&&r.value||0)-Number(i&&i.value||0))*s}return""===o||""===a?0:r.textContent<i.textContent?-1*s:r.textContent>i.textContent?1*s:0}),a.every((t,r)=>t===e.children[r]))return;const l=[];e.children.forEach(t=>{const e=this.tr.doc.resolve(this.tr.mapping.map(t.from)).nodeAfter;this.tr.delete(this.tr.mapping.map(t.from),this.tr.mapping.map(t.to)),l.push({node:e,block:t,from:t.from}),Q(t,e=>{const r=this.tr.doc.resolve(this.tr.mapping.map(e.from)).nodeAfter;this.tr.delete(this.tr.mapping.map(e.from),this.tr.mapping.map(e.to)),l.push({node:r,block:e,from:t.from})})});const c=a.find(t=>r>t.from&&r<t.to),h=c?r-c.from:null;let u=null,p=o;a.forEach(t=>{const e=l.filter(e=>e.from===t.from);t===c&&(u=p),e.forEach(t=>{this.tr.insert(p,t.node),p+=t.node.nodeSize})}),c&&null!==u&&this.tr.setSelection(i.TextSelection.create(this.tr.doc,u+h))}),t};var Ot=function(t,e){if(!I(t))throw new V("toggle");return t.forEach(t=>{const e=this.tr.doc.resolve(this.tr.mapping.map(t.from)).nodeAfter;if(e){const r={...e.attrs};r.visible=!e.attrs.visible,this.tr.setNodeMarkup(this.tr.mapping.map(t.from),null,r)}}),t};var Tt=function(t,e){if(!I(t))throw new V("unindent");return t.forEach(t=>{const e=this.docStruct.find(t.from);this.tr.insertText(X(e.depth-1),this.tr.mapping.map(t.from)+1,this.tr.mapping.map(t.from)+e.depth+1)}),t.map(t=>t.applyMapping(this.tr.mapping))};var Ct=function(t,e){return Date.now()/1e3|0};var Bt=function(t,e){if(!I(t))throw new V("background");if(!e.length)throw new Z("background","argument must have color string");if("string"!==e[0].type)throw new Z("background","argument must have color string");const r=e[0].value;if(/[^#0-9a-zA-Z]/.test(r))throw new Z("background",`argument has invalid color string (${r})`);return t.forEach(t=>{const e=this.tr.doc.resolve(this.tr.mapping.map(t.from)).nodeAfter;if(e&&e.attrs.background!==r){const n={...e.attrs};n.background=r,this.tr.setNodeMarkup(this.tr.mapping.map(t.from),null,n)}}),t};var Wt=function(t,e){if(!I(t))throw new V("bold");return t.forEach(t=>{const e=this.tr.doc.resolve(this.tr.mapping.map(t.from)).nodeAfter;if(e&&!e.attrs.bold){const r={...e.attrs};r.bold=!0,this.tr.setNodeMarkup(this.tr.mapping.map(t.from),null,r)}}),t};var Jt=function(t,e){if(!I(t))throw new V("clearformat");return t.forEach(t=>{const e=this.tr.doc.resolve(this.tr.mapping.map(t.from)).nodeAfter;if(e){const r={...e.attrs};if(r.bold=!1,r.italic=!1,r.underline=!1,r.strikethrough=!1,r.color="",r.background="",JSON.stringify(r)===JSON.stringify(e.attrs))return;this.tr.setNodeMarkup(this.tr.mapping.map(t.from),null,r)}}),t};var $t=function(t,e){if(!I(t))throw new V("color");if(!e.length)throw new Z("color","argument must have color string");if("string"!==e[0].type)throw new Z("color","argument must have color string");const r=e[0].value;if(/[^#0-9a-zA-Z]/.test(r))throw new Z("color",`argument has invalid color string (${r})`);return t.forEach(t=>{const e=this.tr.doc.resolve(this.tr.mapping.map(t.from)).nodeAfter;if(e&&e.attrs.color!==r){const n={...e.attrs};n.color=r,this.tr.setNodeMarkup(this.tr.mapping.map(t.from),null,n)}}),t};var Ft=function(t,e){if(!I(t))throw new V("italic");return t.forEach(t=>{const e=this.tr.doc.resolve(this.tr.mapping.map(t.from)).nodeAfter;if(e&&!e.attrs.italic){const r={...e.attrs};r.italic=!0,this.tr.setNodeMarkup(this.tr.mapping.map(t.from),null,r)}}),t};var Pt=function(t,e){if(!I(t))throw new V("strikethrough");return t.forEach(t=>{const e=this.tr.doc.resolve(this.tr.mapping.map(t.from)).nodeAfter;if(e&&!e.attrs.strikethrough){const r={...e.attrs};r.strikethrough=!0,this.tr.setNodeMarkup(this.tr.mapping.map(t.from),null,r)}}),t};var jt=function(t,e){if(!I(t))throw new V("underline");return t.forEach(t=>{const e=this.tr.doc.resolve(this.tr.mapping.map(t.from)).nodeAfter;if(e&&!e.attrs.underline){const r={...e.attrs};r.underline=!0,this.tr.setNodeMarkup(this.tr.mapping.map(t.from),null,r)}}),t};var Dt=function(t,e){return this.docStruct.lastError?this.docStruct.lastError.message:""};var zt=function(t,e){if(!I(t))throw new V("scroll");if(!t.length)return;if(!this.domAtPos)return;const r=this.domAtPos(t[0].from+1);r&&r.node.scrollIntoView()};var It=function(t,e){if(!q(t))throw new V("avg","array of numbers");let r=0,n=0;return t.forEach(t=>{"number"==typeof t&&(r+=t,n++)}),r/n};var qt=function(t,e){if(!H(t))throw new V("count");return t.length};var Lt=function(t,e){if(!I(t))throw new V("dec");if(!e.length)throw new Z("dec","argument must have a selector");if("selector"!==e[0].type)throw new Z("dec","argument must be a selector");const r=e[0].values[0];return t.forEach(t=>{this.docStruct.find(t.from).features.filter(t=>"tag"===t.type&&t.label===r).forEach(t=>{const e=Number(t.value||0)-1,r=this.tr.mapping.map(t.from),n=this.tr.mapping.map(t.to);this.tr.insertText(t.label+":"+e,r,n)})}),t.map(t=>t.applyMapping(this.tr.mapping))};var Rt=function(t,e){if(!_(t))throw new V("dollar","number(s)");const r=Number((H(t)?t[0]:t)||0);return"$"+String(r.toFixed(2))};const Ut=t=>-1!=="0123456789".indexOf(t);var _t=class extends s{constructor(t){super(t)}readNum(){let t="."===this.istream.peek(),e=this.istream.next();for(;!this.istream.eof();){const r=this.istream.peek();if("."===r){if(t)break;t=!0,e+=r,this.istream.next()}else{if(!Ut(r))break;e+=r,this.istream.next()}}return e}readNext(){if(this.readWhile(a),this.istream.eof())return null;const t=this.istream.peek();return p(t)?(this.istream.next(),{type:"paren",value:t}):u(t)?(this.istream.next(),{type:"operator",value:t}):h(t)?{type:"number",value:this.readNum()}:"#"===t?{type:"var",value:this.readWhile(l)}:d(t)?{type:"fn",value:this.readWhile(d)}:","===t?(this.istream.next(),{type:"comma",value:","}):null}};const Gt=t=>"+"===t||"-"===t?1:"*"===t||"/"===t?2:0,Ht=t=>t[t.length-1];class Vt{constructor(t){this.tstream=t,this.operatorStack=[],this.valueStack=[],this.outputStack=[],this.root=null,this.lastOperator=null}readOperator(t){for(;this.operatorStack.length&&("fn"===Ht(this.operatorStack).type||Gt(Ht(this.operatorStack).value)>=Gt(t.value))&&"("!==Ht(this.operatorStack).value;){const t=this.operatorStack.pop();this.outputStack.push(t)}}readRightParen(){for(;this.operatorStack.length&&"("!==Ht(this.operatorStack).value;)this.outputStack.push(this.operatorStack.pop());if(this.operatorStack.length){if("("!==Ht(this.operatorStack).value)throw new Error("expr: parsing expression failed (no left bracket found)");this.operatorStack.pop()}}parseToken(t,e){const r=e>0?this.tokens[e-1]:null;if("paren"===t.type&&"("===t.value)this.operatorStack.push(t),r&&"fn"===r.type&&this.outputStack.push({type:"stop"});else if("fn"===t.type)this.operatorStack.push(t);else if("number"===t.type||"var"===t.type)t.valueNum=Number(t.value),this.outputStack.push(t);else if("operator"===t.type)!r||"number"!==r.type&&"var"!==r.type&&")"!==r.value?(this.operatorStack.push({type:"fn",value:"unary"+t.value}),this.outputStack.push({type:"stop"})):(this.readOperator(t),this.operatorStack.push(t));else if("paren"===t.type&&")"===t.value){if(!r||"comma"===r.type)throw new Error("expr: parsing expression failed (comma before closed bracket)");this.readRightParen(t)}else if("comma"===t.type){if(!r||"operator"===r.type||"comma"===r.type)throw new Error("expr: parsing expression failed");"operator"===Ht(this.operatorStack).type&&this.outputStack.push(this.operatorStack.pop())}}parseTokens(t){this.tokens.forEach((t,e)=>this.parseToken(t,e))}parse(){for(this.tokens=[];!this.tstream.eof();)this.tokens.push(this.tstream.next());for(this.parseTokens();this.operatorStack.length;){if("paren"===Ht(this.operatorStack).type)throw new Error("expr: mismatched brackets");this.outputStack.push(this.operatorStack.pop())}return this.outputStack}}const Zt=t=>{const e=new o(t),r=new _t(e);return new Vt(r).parse()},Qt={min(){return Math.min.apply(Math,arguments)},max(){return Math.max.apply(Math,arguments)},sin:t=>Math.sin(t),cos:t=>Math.cos(t),tan:t=>Math.tan(t),pow:(t,e)=>Math.pow(t,e),fixed:(t,e)=>t.toFixed(e),abs:t=>Math.abs(t),random:()=>Math.random(),ceil:t=>Math.ceil(t),floor:t=>Math.floor(t),round:t=>Math.round(t),sqrt:t=>Math.sqrt(t),add:(t,e)=>t+e,subtract:(t,e)=>t-e,multiply:(t,e)=>t*e,divide:(t,e)=>t/e,unaryNegative:t=>-t,unaryPositive:t=>+t};Qt["+"]=Qt.add,Qt["-"]=Qt.subtract,Qt["*"]=Qt.multiply,Qt["/"]=Qt.divide,Qt["unary-"]=Qt.unaryNegative,Qt["unary+"]=Qt.unaryPositive;class Yt{constructor(t){this.ast=t,this.prepared=!1,this.functionMap=Qt}variables(t){const e={};return this.ast.filter(t=>"var"===t.type).map(t=>t.value).forEach(r=>{e[r]=t}),e}prepare(t){this.ast.filter(t=>"var"===t.type).forEach(e=>{if(!(e.value in t))throw new Error(`expr: expected variable (${e.value})`);e.valueNum=t[e.value]}),this.prepared=!0}evaluate(){const t=[];for(let e=0;e<this.ast.length;++e){const r=this.ast[e];if("operator"===r.type||"fn"===r.type){const e=this.functionMap[r.value];let n;if(!e)throw new Error(`expr: unrecognised expression function (${r.value})`);if("fn"===r.type){const r=[];for(;t.length&&"stop"!==Ht(t).type;)r.unshift(t.pop().valueNum);t.length&&"stop"===Ht(t).type&&t.pop(),n=e.apply(e,r)}else if("operator"===r.type){const r=t.pop(),i=t.pop();if(void 0===i||void 0===r)throw new Error("expr: invalid use of operator");n=e(i.valueNum,r.valueNum)}t.push({type:"number",valueNum:n})}else"var"===r.type||"number"===r.type?t.push(r):"stop"===r.type&&t.push(r)}return t}}const Kt=(t,e,r)=>{const n=r.find(e);return Object.keys(t).forEach(e=>{let i=n.features.find(t=>"tag"===t.type&&t.label===e);if(!i){const t=((t,e,r)=>{let n,i=r.parent;do{if(i.features.find(t=>"tag"===t.type&&t.value===e))return i}while(i=i.parent);if(t.recurseTree(r,t=>{if(t.features.find(t=>"tag"===t.type&&t.value===e))return n=t,!1}),n)return n;const o=t.index[e];return o&&o.length?o[0]:void 0})(r,e,n);t&&(i=t.features.find(t=>"tag"===t.type&&t.label===e))}t[e]=i?Number(i.value||0):0}),t};var Xt={after:et,before:nt,duplicate:it,flatten:ot,hide:st,indent:at,move:St,pos:Nt,remove:Et,show:At,sort:Mt,toggle:Ot,unindent:Tt,now:Ct,background:Bt,bold:Wt,clearformat:Jt,color:$t,italic:Ft,strikethrough:Pt,underline:jt,error:Dt,scroll:zt,avg:It,count:qt,dec:Lt,dollar:Rt,expr:function(t,e){const r=I(t);if(!r&&!_(t))throw new V("expr");if(!e.length)throw new Z("expr","arguments must have a string");if("string"!==e[0].type)throw new Z("expr","argument must be a string");const n=e[0].value;if(!n)return;const i=Zt(n);if(!i)return;const o=[];return(R(t)?[t]:t).forEach(t=>{const e=new Yt(i),n=e.variables();r?Kt(n,t.from,this.docStruct):n["#x"]=t,e.prepare(n);const s=e.evaluate().pop();s&&o.push(s.valueNum)}),o},inc:function(t,e){if(!I(t))throw new V("inc");if(!e.length)throw new Z("inc","argument must have a selector");if("selector"!==e[0].type)throw new Z("inc","argument must be a selector");const r=e[0].values[0];return t.forEach(t=>{this.docStruct.find(t.from).features.filter(t=>"tag"===t.type&&t.label===r).forEach(t=>{const e=Number(t.value||0)+1,r=this.tr.mapping.map(t.from),n=this.tr.mapping.map(t.to);this.tr.insertText(t.label+":"+e,r,n)})}),t.map(t=>t.applyMapping(this.tr.mapping))},max:function(t,e){if(!I(t)&&!U(t))throw new V("max");if(!t.length)throw new V("max");const r=U(t);if(I(t),r)return Math.max.apply(Math,t);const n=e[0]&&"selector"===e[0].type&&e[0].values[0];if(!n)return[];let i=-1/0,o=null;return t.forEach(t=>{this.docStruct.find(t.from).features.filter(t=>"tag"===t.type&&t.label===n).forEach(e=>{const r=Number(e.value||0);r>i&&(i=r,o=t)})}),o?[o]:[]},min:function(t,e){if(!I(t)&&!U(t))throw new V("min");if(!t.length)throw new V("min");const r=U(t);if(I(t),r)return Math.min.apply(Math,t);const n=e[0]&&"selector"===e[0].type&&e[0].values[0];if(!n)return[];let i=1/0,o=null;return t.forEach(t=>{this.docStruct.find(t.from).features.filter(t=>"tag"===t.type&&t.label===n).forEach(e=>{const r=Number(e.value||0);r<i&&(i=r,o=t)})}),o?[o]:[]},pct:function(t,e){if(!_(t))throw new V("pct","number(s)");const r=Number((H(t)?t[0]:t)||0),n=e[0]&&"number"===e[0].type?Number(e[0].value):0;return String((100*r).toFixed(n))+"%"},fixed:function(t,e){if(!_(t))throw new V("fixed","number(s)");const r=Number((H(t)?t[0]:t)||0),n=e[0]&&"number"===e[0].type?Number(e[0].value):0;return r.toFixed(n)},setval:function(t,e){if(!L(t))throw new V("setval","scalar(s)");if(!e.length)throw new Z("setval","argument must have a selector");if("selector"!==e[0].type)throw new Z("setval","argument must be a selector");const r=e[0].values[0],n=e[1]&&"nested"===e[1].type?this.executeNewContext(e[1].value,wt):[this.docStruct.find(this.blockFrom)],i=String(parseFloat((H(t)?t[0]:t)||0,10));return n.forEach(t=>{this.docStruct.find(t.from).features.filter(t=>"tag"===t.type&&t.label===r).forEach(t=>{if(String(t.value)===i)return;const e=this.tr.mapping.map(t.from),r=this.tr.mapping.map(t.to);this.tr.insertText(t.label+":"+i,e,r)})}),t},sum:function(t,e){if(!q(t))throw new V("val","array of numbers");let r=0;return t.forEach(t=>{"number"==typeof t&&(r+=t)}),r},val:function(t,e){if(!I(t))throw new V("val");if(!e.length)throw new Z("val","arguments must have a selector");if("selector"!==e[0].type)throw new Z("set","argument must be a selector");const r=[],n=e[0]&&"selector"===e[0].type?e[0].values[0]:null,i=e[1]&&"ident"===e[1].type&&"all"===e[1].value;return n?(t.forEach(t=>{const e=this.docStruct.find(t.from).features.filter(t=>"tag"===t.type&&t.label===n),o=i?e:e.slice(0,1);o.length&&o.forEach(t=>{r.push(Number(t.value||0))})}),r):[]},all:lt,children:ct,descendants:ht,filter:ut,first:pt,last:dt,next:ft,not:mt,parent:gt,prev:bt,select:xt,siblings:kt,slice:yt,this:vt,compact:function(t,e){if(!G(t))throw new V("compact","strings");return t.map(t=>t.replace(/\s+/g," ").trim())},join:function(t,e){if(!q(t))throw new V("join","strings");const r=e[0]&&"string"===e[0].type?e[0].value:", ";return t.join(r)},text:function(t,e){if(!I(t))throw new V("text");const r=e[0]&&"ident"===e[0].type&&"all"===e[0].value,n=[];return t.forEach(t=>{const e=this.docStruct.find(t.from),i=this.tr.doc.resolve(this.tr.mapping.map(t.from)).nodeAfter.textContent;let o="";if(r)o+=i;else{let r=0;e.features.forEach(e=>{const n=e.from-t.from-1;o+=i.substring(r,n),r=e.to-t.from-1}),o+=i.substring(r,i.length)}n.push(o)}),n},trim:function(t,e){if(!G(t))throw new V("trim","strings");return t.map(t=>t.trim())},addtag:function(t,e){if(!I(t))throw new V("addtag");if(!e.length)throw new Z("addtag","argument must have selector");if("selector"!==e[0].type)throw new Z("addtag","argument must be selector");const r=e[0].values[0],n=Boolean(e[1]&&"ident"===e[1].type&&"once"===e[1].value);return t.forEach(t=>{const e=this.docStruct.find(t.from),i=this.tr.doc.resolve(this.tr.mapping.map(t.from)).nodeAfter,o=i?i.attrs.tail.length:0,s=e.features.find(t=>"tag"===t.type&&t.label===r);if(n&&s)return;const a=i.textContent,l=a.substr(a.length-o-1,1);this.tr.insertText((" "===l?"":" ")+r,this.tr.mapping.map(t.to-o-1))}),t.map(t=>t.applyMapping(this.tr.mapping))},removetag:function(t,e){if(!I(t))throw new V("removetag");if(!e.length)throw new Z("removetag","argument must have selector");if("selector"!==e[0].type)throw new Z("removetag","argument must be selector");const r=e[0].values[0],n=Boolean(e[1]&&"ident"===e[1].type&&"all"===e[1].value);return t.forEach(t=>{const e=this.docStruct.find(t.from).features.filter(t=>"tag"===t.type&&t.label===r);(n?e:e.slice(0,1)).forEach(t=>{this.tr.mapping.map(t.from);this.tr.insertText("",this.tr.mapping.map(t.from),this.tr.mapping.map(t.to)),this.docStruct.build(this.tr)})}),t.map(t=>t.applyMapping(this.tr.mapping))},toggletag:function(t,e){if(!I(t))throw new V("toggletag");if(!e.length)throw new Z("toggletag","argument must have selector");if("selector"!==e[0].type)throw new Z("toggletag","argument must be selector");const r=e[0].values[0];return t.forEach(t=>{const e=this.docStruct.find(t.from).features.filter(t=>"tag"===t.type&&t.label===r);if(e.length)e.forEach(t=>{this.tr.mapping.map(t.from);this.tr.insertText("",this.tr.mapping.map(t.from),this.tr.mapping.map(t.to)),this.docStruct.build(this.tr)});else{const e=this.tr.doc.resolve(this.tr.mapping.map(t.from)).nodeAfter,n=e?e.attrs.tail.length:0,i=e.textContent,o=i.substr(i.length-n-1,1);this.tr.insertText((" "===o?"":" ")+r,this.tr.mapping.map(t.to-n-1))}}),t.map(t=>t.applyMapping(this.tr.mapping))},">":ct,"*":ht};class te{constructor(t){this.state=i.EditorState.create({doc:n.nodeFromJSON(t),schema:n}),this.lastExec=null,this.docStruct=new T,this.docStruct.build(this.state)}run(t,e){const r=A(t),n=new W(r,e||0,this.state,{},this.docStruct,Xt);return this.lastExec=n,n}getNode(t){return this.state.doc.resolve(t).nodeAfter}apply(){this.state=this.lastExec.currentState,this.docStruct.build(this.state)}}const ee=t=>new te(t),re={type:"doc",content:[{type:"block",attrs:{visible:!0,underline:!1,bold:!1,italic:!1,strikethrough:!1,color:"black",tail:"",head:"[ ] "},content:[{type:"text",text:"#test line"}]},{type:"block",attrs:{visible:!0,underline:!1,bold:!1,italic:!1,strikethrough:!1,color:"black",tail:"",head:""},content:[{type:"text",text:"another #test #with #more #tags"}]},{type:"block",attrs:{visible:!0,underline:!1,bold:!1,italic:!1,strikethrough:!1,color:"black",tail:"",head:""},content:[{type:"text",text:"this #isnt"}]},{type:"block",attrs:{visible:!0,underline:!1,bold:!1,italic:!1,strikethrough:!1,color:"black",tail:"",head:""},content:[{type:"text",text:"\tchild 1"}]},{type:"block",attrs:{visible:!0,underline:!1,bold:!1,italic:!1,strikethrough:!1,color:"black",tail:"",head:""},content:[{type:"text",text:"\tchild 2 #x"}]},{type:"block",attrs:{visible:!0,underline:!1,bold:!1,italic:!1,strikethrough:!1,color:"black",tail:"",head:""},content:[{type:"text",text:"\tchild 3"}]},{type:"block",attrs:{visible:!0,underline:!1,bold:!1,italic:!1,strikethrough:!1,color:"black",tail:"",head:""},content:[{type:"text",text:"\t\tsubchild"}]}]};const ne={type:"doc",content:[{type:"block",attrs:{visible:!0,underline:!1,bold:!1,italic:!1,strikethrough:!1,color:"black",tail:"",head:"[ ] "},content:[{type:"text",text:"#test line"}]},{type:"block",attrs:{visible:!0,underline:!1,bold:!1,italic:!1,strikethrough:!1,color:"black",tail:"",head:""},content:[{type:"text",text:"another #test #with #more #tags"}]},{type:"block",attrs:{visible:!0,underline:!1,bold:!1,italic:!1,strikethrough:!1,color:"black",tail:"",head:""},content:[{type:"text",text:"this #isnt"}]},{type:"block",attrs:{visible:!0,underline:!1,bold:!1,italic:!1,strikethrough:!1,color:"black",tail:"",head:""},content:[{type:"text",text:"\tchild 1"}]},{type:"block",attrs:{visible:!0,underline:!1,bold:!1,italic:!1,strikethrough:!1,color:"black",tail:"",head:""},content:[{type:"text",text:"\tchild 2 #x"}]},{type:"block",attrs:{visible:!0,underline:!1,bold:!1,italic:!1,strikethrough:!1,color:"black",tail:"",head:""},content:[{type:"text",text:"\tchild 3"}]},{type:"block",attrs:{visible:!0,underline:!1,bold:!1,italic:!1,strikethrough:!1,color:"black",tail:"",head:""},content:[{type:"text",text:"\t\tsubchild"}]}]};const ie={type:"doc",content:[{type:"block",attrs:{visible:!0,underline:!1,bold:!1,italic:!1,strikethrough:!1,color:"black",background:"",tail:"",head:""},content:[{type:"text",text:"#A"}]},{type:"block",attrs:{visible:!0,underline:!1,bold:!1,italic:!1,strikethrough:!1,color:"black",background:"",tail:"",head:""},content:[{type:"text",text:"\t1"}]},{type:"block",attrs:{visible:!0,underline:!1,bold:!1,italic:!1,strikethrough:!1,color:"black",background:"",tail:"",head:""},content:[{type:"text",text:"\t\ta"}]},{type:"block",attrs:{visible:!0,underline:!1,bold:!1,italic:!1,strikethrough:!1,color:"black",background:"",tail:"",head:""},content:[{type:"text",text:"\t\t\tb"}]},{type:"block",attrs:{visible:!0,underline:!1,bold:!1,italic:!1,strikethrough:!1,color:"black",background:"",tail:"",head:""},content:[{type:"text",text:"\t2"}]},{type:"block",attrs:{visible:!0,underline:!1,bold:!1,italic:!1,strikethrough:!1,color:"black",background:"",tail:"",head:""},content:[{type:"text",text:"\t3"}]},{type:"block",attrs:{visible:!0,underline:!1,bold:!1,italic:!1,strikethrough:!1,color:"black",background:"",tail:"",head:""},content:[{type:"text",text:"#B"}]}]};const oe={type:"doc",content:[{type:"block",attrs:{visible:!0,underline:!1,bold:!1,italic:!1,strikethrough:!1,color:"black",background:"",tail:"",head:""},content:[{type:"text",text:"#A"}]},{type:"block",attrs:{visible:!0,underline:!1,bold:!1,italic:!1,strikethrough:!1,color:"black",background:"",tail:"",head:""},content:[{type:"text",text:"\t1 #n"}]},{type:"block",attrs:{visible:!0,underline:!1,bold:!1,italic:!1,strikethrough:!1,color:"black",background:"",tail:"",head:""},content:[{type:"text",text:"\t\ta"}]},{type:"block",attrs:{visible:!0,underline:!1,bold:!1,italic:!1,strikethrough:!1,color:"black",background:"",tail:"",head:""},content:[{type:"text",text:"\t\t\tb"}]},{type:"block",attrs:{visible:!0,underline:!1,bold:!1,italic:!1,strikethrough:!1,color:"black",background:"",tail:"",head:""},content:[{type:"text",text:"\t2"}]},{type:"block",attrs:{visible:!0,underline:!1,bold:!1,italic:!1,strikethrough:!1,color:"black",background:"",tail:"",head:""},content:[{type:"text",text:"\t3 #n:2"}]},{type:"block",attrs:{visible:!0,underline:!1,bold:!1,italic:!1,strikethrough:!1,color:"black",background:"",tail:"",head:""},content:[{type:"text",text:"#B"}]}]};const se={type:"doc",content:[{type:"block",attrs:{visible:!0,underline:!1,bold:!1,italic:!1,strikethrough:!1,color:"black",tail:"",head:""},content:[{type:"text",text:"#A"}]},{type:"block",attrs:{visible:!0,underline:!1,bold:!1,italic:!1,strikethrough:!1,color:"black",tail:"",head:""},content:[{type:"text",text:"\t1"}]},{type:"block",attrs:{visible:!0,underline:!1,bold:!1,italic:!1,strikethrough:!1,color:"black",tail:"",head:""},content:[{type:"text",text:"\t\ta"}]},{type:"block",attrs:{visible:!0,underline:!1,bold:!1,italic:!1,strikethrough:!1,color:"black",tail:"",head:""},content:[{type:"text",text:"\t\t\tb"}]},{type:"block",attrs:{visible:!0,underline:!1,bold:!1,italic:!1,strikethrough:!1,color:"black",tail:"",head:""},content:[{type:"text",text:"\t2"}]},{type:"block",attrs:{visible:!0,underline:!1,bold:!1,italic:!1,strikethrough:!1,color:"black",tail:"",head:""},content:[{type:"text",text:"\t3"}]},{type:"block",attrs:{visible:!0,underline:!1,bold:!1,italic:!1,strikethrough:!1,color:"black",tail:"",head:""},content:[{type:"text",text:"#B"}]}]};const ae={type:"doc",content:[{type:"block",attrs:{visible:!0,underline:!1,bold:!1,italic:!1,strikethrough:!1,color:"black",tail:"",head:""},content:[{type:"text",text:"this is a line #endingwith"}]},{type:"block",attrs:{visible:!0,underline:!1,bold:!1,italic:!1,strikethrough:!1,color:"black",tail:"",head:""},content:[{type:"text",text:"#startingwith tag"}]},{type:"block",attrs:{visible:!0,underline:!1,bold:!1,italic:!1,strikethrough:!1,color:"black",tail:"",head:""},content:[{type:"text",text:"add tag with #after"}]},{type:"block",attrs:{visible:!0,underline:!1,bold:!1,italic:!1,strikethrough:!1,color:"black",tail:"",head:""},content:[{type:"text",text:"#before add tag with #before"}]},{type:"block",attrs:{visible:!0,underline:!1,bold:!1,italic:!1,strikethrough:!1,color:"black",tail:"",head:""},content:[{type:"text",text:"#lines #with #all #tags"}]}]};const le={type:"doc",content:[{type:"block",attrs:{visible:!0,underline:!1,bold:!1,italic:!1,strikethrough:!1,color:"black",tail:"",head:""},content:[{type:"text",text:"#a #b"}]},{type:"block",attrs:{visible:!0,underline:!1,bold:!1,italic:!1,strikethrough:!1,color:"black",tail:"",head:""},content:[{type:"text",text:"#a:4"}]},{type:"block",attrs:{visible:!0,underline:!1,bold:!1,italic:!1,strikethrough:!1,color:"black",tail:"",head:""},content:[{type:"text",text:"#a:2"}]}]};const ce={type:"doc",content:[{type:"block",attrs:{visible:!0,underline:!1,bold:!1,italic:!1,strikethrough:!1,color:"black",tail:"",head:""},content:[{type:"text",text:"#a"}]},{type:"block",attrs:{visible:!0,underline:!1,bold:!1,italic:!1,strikethrough:!1,color:"black",tail:"",head:""},content:[{type:"text",text:"#b"}]}]};const he={type:"doc",content:[{type:"block",attrs:{visible:!0,underline:!1,bold:!1,italic:!1,strikethrough:!1,color:"black",tail:"",head:""},content:[{type:"text",text:"this is a #line of text"}]},{type:"block",attrs:{visible:!0,underline:!1,bold:!1,italic:!1,strikethrough:!1,color:"black",tail:"",head:""},content:[{type:"text",text:"#many #tags with [x](this) buttons"}]}]};const ue=new class{constructor(){this.tests=[]}register(t){this.tests.push(t)}test(t,e,r){return e===r?(console.log(`  + ${t} passed`),!0):(console.log(`  - ${t} failed!`),console.log("  A:",e),console.log("  B:",r),!1)}run(){console.log("-----------------------"),console.log(" QWORP Automated Tests "),console.log("-----------------------"),console.log(`Running ${this.tests.length} tests`);for(let t=0;t<this.tests.length;++t){const e=this.tests[t];if(console.log(`\n[ ${t+1}. ${e.name} ]`),!1===e.fn.call(this))return console.log(),void console.log("FAILED")}console.log(),console.log("ALL TESTS PASSED")}},pe=(t,e)=>{ue.register({name:t,fn:e})};((t,e)=>{e("Basic Selector",(function(){const e=t(re).run("#test").execute();if(!this.test("two blocks found",e.length,2))return!1})),e("AND Selector",(function(){const e=t(re).run("#test #tags").execute();return!!this.test("one blocks found",e.length,1)&&(!!this.test("block found in correct position",e[0].from,12)&&void 0)})),e("OR Selector",(function(){const e=t(re).run("#test | #isnt").execute();if(!this.test("three blocks found",e.length,3))return!1})),e("Children Selector",(function(){const e=t(re).run("#isnt | children incl").execute();if(!this.test("four blocks found",e.length,4))return!1})),e("Children ONLY Selector",(function(){const e=t(re).run("#isnt | children").execute();if(!this.test("three blocks found",e.length,3))return!1})),e("Descendants Selector",(function(){const e=t(re).run("#isnt | *").execute();if(!this.test("four blocks found",e.length,4))return!1})),e("NOT Selector",(function(){const e=t(re).run("#test | not #tags").execute();if(!this.test("one blocks found",e.length,1))return!1})),e("ALL Selector",(function(){const e=t(re).run("all").execute();if(!this.test("all blocks found",e.length,7))return!1})),e("THIS Selector",(function(){const e=t(re),r=e.run("this").execute(),n=e.getNode(r[0].from);return!!this.test("block found",r.length,1)&&(!!this.test("correct size",n.textContent.length,10)&&void 0)})),e("Next Selector",(function(){const e=t(re);let r=e.run("#more | next 1").execute();return!!this.test("next block found",r.length,1)&&(r=e.run("#test | next all").execute(),!!this.test("next block without argument",r.length,2)&&void 0)})),e("Prev Selector",(function(){const e=t(re);let r=e.run("#more | prev 1").execute();return!!this.test("previous block found",r.length,1)&&(r=e.run("#isnt | prev all").execute(),!!this.test("previous block without argument",r.length,2)&&void 0)})),e("Parent Selector",(function(){const e=t(re);let r=e.run("#x | parent").execute();return!!this.test("parent",r.length,1)&&(r=e.run("#x | parent incl").execute(),!!this.test("parent including original",r.length,2)&&void 0)})),e("Siblings Selector",(function(){const e=t(re).run("#isnt | siblings").execute();if(!this.test("found siblings",e.length,2))return!1})),e("First / Last",(function(){const e=t(re);let r=e.run("#test | first").execute(),n=e.getNode(r[0].from);return!!this.test("found first",n.textContent,"#test line")&&(r=e.run("#test | last").execute(),n=e.getNode(r[0].from),!!this.test("found last",n.textContent,"another #test #with #more #tags")&&void 0)})),e("Slice",(function(){const e=t(re);let r=e.run("#test | slice 0 1").execute(),n=e.getNode(r[0].from);return!!this.test("found first",n.textContent,"#test line")&&(r=e.run("#test | slice -1").execute(),n=e.getNode(r[0].from),!!this.test("found last",n.textContent,"another #test #with #more #tags")&&void 0)}))})(ee,pe),((t,e)=>{e("Hide/Show/Toggle",(function(){const e=t(ne);e.run("#test | hide").execute(),e.apply();let r=e.run("#test").execute(),n=e.state.doc.resolve(r[0].from).nodeAfter;return!!this.test("hide sets attr",n.attrs.visible,!1)&&(e.run("#test | show").execute(),e.apply(),r=e.run("#test").execute(),n=e.state.doc.resolve(r[0].from).nodeAfter,!!this.test("show sets attr",n.attrs.visible,!0)&&(e.run("#test | toggle").execute(),e.apply(),r=e.run("#test").execute(),n=e.state.doc.resolve(r[0].from).nodeAfter,!!this.test("toggle sets attr",n.attrs.visible,!1)&&void 0))}))})(ee,pe),((t,e)=>{e("Move children",(function(){const e=t(ie);e.run("#A | > only | move `#B`").execute(),e.apply();let r=JSON.stringify({type:"doc",content:[{type:"block",attrs:{visible:!0,underline:!1,bold:!1,italic:!1,strikethrough:!1,color:"black",background:"",tail:"",head:""},content:[{type:"text",text:"#A"}]},{type:"block",attrs:{visible:!0,underline:!1,bold:!1,italic:!1,strikethrough:!1,color:"black",background:"",tail:"",head:""},content:[{type:"text",text:"#B"}]},{type:"block",attrs:{visible:!0,underline:!1,bold:!1,italic:!1,strikethrough:!1,color:"black",background:"",tail:"",head:""},content:[{type:"text",text:"\t1"}]},{type:"block",attrs:{visible:!0,underline:!1,bold:!1,italic:!1,strikethrough:!1,color:"black",background:"",tail:"",head:""},content:[{type:"text",text:"\t\ta"}]},{type:"block",attrs:{visible:!0,underline:!1,bold:!1,italic:!1,strikethrough:!1,color:"black",background:"",tail:"",head:""},content:[{type:"text",text:"\t\t\tb"}]},{type:"block",attrs:{visible:!0,underline:!1,bold:!1,italic:!1,strikethrough:!1,color:"black",background:"",tail:"",head:""},content:[{type:"text",text:"\t2"}]},{type:"block",attrs:{visible:!0,underline:!1,bold:!1,italic:!1,strikethrough:!1,color:"black",background:"",tail:"",head:""},content:[{type:"text",text:"\t3"}]}]}),n=JSON.stringify(e.state.doc.toJSON());return!!this.test("move children from A to B",r,n)&&(e.run("#B | > only | move `#A`").execute(),e.apply(),r=JSON.stringify(ie),n=JSON.stringify(e.state.doc.toJSON()),!!this.test("move children from B to A",r,n)&&void 0)})),e("Move descendants",(function(){const e=t(ie);e.run("#A | * only | move `#B`").execute(),e.apply();let r=JSON.stringify({type:"doc",content:[{type:"block",attrs:{visible:!0,underline:!1,bold:!1,italic:!1,strikethrough:!1,color:"black",background:"",tail:"",head:""},content:[{type:"text",text:"#A"}]},{type:"block",attrs:{visible:!0,underline:!1,bold:!1,italic:!1,strikethrough:!1,color:"black",background:"",tail:"",head:""},content:[{type:"text",text:"#B"}]},{type:"block",attrs:{visible:!0,underline:!1,bold:!1,italic:!1,strikethrough:!1,color:"black",background:"",tail:"",head:""},content:[{type:"text",text:"\t1"}]},{type:"block",attrs:{visible:!0,underline:!1,bold:!1,italic:!1,strikethrough:!1,color:"black",background:"",tail:"",head:""},content:[{type:"text",text:"\t\ta"}]},{type:"block",attrs:{visible:!0,underline:!1,bold:!1,italic:!1,strikethrough:!1,color:"black",background:"",tail:"",head:""},content:[{type:"text",text:"\t\t\tb"}]},{type:"block",attrs:{visible:!0,underline:!1,bold:!1,italic:!1,strikethrough:!1,color:"black",background:"",tail:"",head:""},content:[{type:"text",text:"\t2"}]},{type:"block",attrs:{visible:!0,underline:!1,bold:!1,italic:!1,strikethrough:!1,color:"black",background:"",tail:"",head:""},content:[{type:"text",text:"\t3"}]}]}),n=JSON.stringify(e.state.doc.toJSON());return!!this.test("move descendants from A to B",r,n)&&(e.run("#B | * only | move `#A`").execute(),e.apply(),r=JSON.stringify(ie),n=JSON.stringify(e.state.doc.toJSON()),!!this.test("move descendants from B to A",r,n)&&void 0)}))})(ee,pe),((t,e)=>{e("Sort children",(function(){const e=t(oe);e.run("#A | sort #n asc").execute(),e.apply();let r=JSON.stringify(oe),n=JSON.stringify(e.state.doc.toJSON());return!!this.test("Sort tag ascending",r,n)&&(e.run("#A | sort #n desc").execute(),e.apply(),r=JSON.stringify({type:"doc",content:[{type:"block",attrs:{visible:!0,underline:!1,bold:!1,italic:!1,strikethrough:!1,color:"black",background:"",tail:"",head:""},content:[{type:"text",text:"#A"}]},{type:"block",attrs:{visible:!0,underline:!1,bold:!1,italic:!1,strikethrough:!1,color:"black",background:"",tail:"",head:""},content:[{type:"text",text:"\t3 #n:2"}]},{type:"block",attrs:{visible:!0,underline:!1,bold:!1,italic:!1,strikethrough:!1,color:"black",background:"",tail:"",head:""},content:[{type:"text",text:"\t1 #n"}]},{type:"block",attrs:{visible:!0,underline:!1,bold:!1,italic:!1,strikethrough:!1,color:"black",background:"",tail:"",head:""},content:[{type:"text",text:"\t\ta"}]},{type:"block",attrs:{visible:!0,underline:!1,bold:!1,italic:!1,strikethrough:!1,color:"black",background:"",tail:"",head:""},content:[{type:"text",text:"\t\t\tb"}]},{type:"block",attrs:{visible:!0,underline:!1,bold:!1,italic:!1,strikethrough:!1,color:"black",background:"",tail:"",head:""},content:[{type:"text",text:"\t2"}]},{type:"block",attrs:{visible:!0,underline:!1,bold:!1,italic:!1,strikethrough:!1,color:"black",background:"",tail:"",head:""},content:[{type:"text",text:"#B"}]}]}),n=JSON.stringify(e.state.doc.toJSON()),!!this.test("Sort tag descending",r,n)&&(e.run("#A | sort").execute(),e.apply(),r=JSON.stringify(oe),n=JSON.stringify(e.state.doc.toJSON()),!!this.test("Sort tag defaults",r,n)&&void 0))}))})(ee,pe),((t,e)=>{e("Before",(function(){const e=t(se);let r=e.run('#A | children only | before "**"').execute();e.apply(),r=e.run("#A | children only").execute();let n=!0;return r.forEach(t=>{const r=e.getNode(t.from);this.test("Check node text "+t.from,r.textContent.startsWith("\t**"),!0)||(n=!1),this.test("Check node head attrs "+t.from,r.attrs.head,"**")||(n=!1)}),n})),e("After",(function(){const e=t(se);let r=e.run('#A | children only | after "$$$"').execute();e.apply(),r=e.run("#A | children only").execute();let n=!0;return r.forEach(t=>{const r=e.getNode(t.from);this.test("Check node text "+t.from,r.textContent.endsWith("$$$"),!0)||(n=!1),this.test("Check node tail attrs "+t.from,r.attrs.tail,"$$$")||(n=!1)}),n}))})(ee,pe),((t,e)=>{e("Add tag",(function(){const e=t(ae);let r,n;return e.run('#after | after "<"').execute(),e.apply(),e.run("#endingwith | addtag #newtag").execute(),e.apply(),r=e.run("#endingwith").execute(),n=e.getNode(r[0].from),!!this.test("Tag added at end","this is a line #endingwith #newtag",n.textContent)&&(e.run("#endingwith | addtag #newtag once").execute(),e.apply(),r=e.run("#endingwith").execute(),n=e.getNode(r[0].from),!!this.test("Only add single tag (once)","this is a line #endingwith #newtag",n.textContent)&&(e.run("#after | addtag #newtag").execute(),e.apply(),r=e.run("#after").execute(),n=e.getNode(r[0].from),!!this.test("Add tag before the tail","add tag with #after #newtag<",n.textContent)&&void 0))})),e("Remove tag",(function(){const e=t(ae);let r,n;if(e.run('#before | before ">"').execute(),e.apply(),e.run("#before | removetag #before all").execute(),e.apply(),r=e.run("#after | next 1").execute(),n=e.getNode(r[0].from),!this.test("Tag removed","> add tag with ",n.textContent))return!1})),e("Toggle tag",(function(){const e=t(ae);let r,n;return e.run("#lines | toggletag #toggled").execute(),e.apply(),r=e.run("#lines").execute(),n=e.getNode(r[0].from),!!this.test("Tag toggled on","#lines #with #all #tags #toggled",n.textContent)&&(e.run("#lines | toggletag #toggled").execute(),e.apply(),r=e.run("#lines").execute(),n=e.getNode(r[0].from),!!this.test("Tag toggled off","#lines #with #all #tags ",n.textContent)&&(e.run("#lines | toggletag #toggled").execute(),e.apply(),r=e.run("#lines").execute(),n=e.getNode(r[0].from),!!this.test("Tag toggled back on","#lines #with #all #tags #toggled",n.textContent)&&void 0))}))})(ee,pe),((t,e)=>{e("Increment",(function(){const e=t(le);let r;e.run("#a #b | inc #a").execute(),e.apply(),r=e.run("#a #b").execute();const n=e.docStruct.find(r[0].from).features[0];if(!this.test("Did empty #a tag increment",n.value,"1"))return!1})),e("Decrement",(function(){const e=t(le);let r;e.run("#a #b | dec #a").execute(),e.apply(),r=e.run("#a #b").execute();const n=e.docStruct.find(r[0].from).features[0];if(!this.test("Did empty #a tag decrement",n.value,"-1"))return!1})),e("Setval and Count",(function(){const e=t(le);let r;e.run("#a | count | setval #b `#b`").execute(),e.apply(),r=e.run("#a #b").execute();const n=e.docStruct.find(r[0].from).features[1];if(!this.test("Did empty #a tag set by count",n.value,"3"))return!1})),e("Val and Sum",(function(){const e=t(le);let r;return r=e.run("#a | val #a | sum").execute(),!!this.test("Sum the value of #a",r,6)&&(e.run("#b | addtag #a").execute(),e.apply(),e.run("#b | inc #a").execute(),e.apply(),r=e.run("#a | val #a all | sum").execute(),!!this.test("Sum the value of all #a",r,8)&&void 0)})),e("Min / Max",(function(){const e=t(le);let r;return r=e.run("#a | val #a all | min").execute(),!!this.test("Min #a",r,0)&&(r=e.run("#a | min #a").execute(),!!this.test("Get the minimum block",r.length,1)&&(r=e.run("#a | val #a all | max").execute(),!!this.test("Max #a",r,4)&&(r=e.run("#a | max #a").execute(),!!this.test("Get the max block",r.length,1)&&void 0)))})),e("Expr",(function(){const e=t(le);let r;return r=e.run('expr "min(1,2)"').execute(),!!this.test("Minimum of 1 and 2",r[0],1)&&(r=e.run('expr "min(max(1*4+2,1),2/1, 0)"').execute(),!!this.test("Complex nested min math functions with many arguments",r[0],0)&&(r=e.run('expr "ceil(sqrt(2) * (1/3))"').execute(),!!this.test("Another complex formula",r[0],1)&&(e.run("#b | inc #a | inc #a | inc #b").execute(),e.apply(),r=e.run('expr "min(2 * #a, #b / 2, 2) / 0.5 + 1"').execute(),!!this.test("Using tag values in complex formula",r[0],2)&&(r=e.run('expr "#a + #b - #a + -#b"').execute(),!!this.test("Using tag values simply",r[0],0)&&void 0))))}))})(ee,pe),((t,e)=>{e("Duplicate",(function(){const e=t(ce);let r;return e.run("#a | duplicate").execute(),e.apply(),r=e.run("#a").execute(),!!this.test("found clone of #a",r.length,2)&&(e.run("#b | duplicate | addtag #copy").execute(),e.apply(),r=e.run("#copy").execute(),!!this.test("found cloned tag #copy",r.length,1)&&void 0)})),e("Remove block",(function(){const e=t(ce);let r;if(e.run("#b | remove").execute(),e.apply(),r=e.run("#b").execute(),!this.test("removed node not found",r.length,0))return!1}))})(ee,pe),((t,e)=>{e("Text",(function(){const e=t(he);let r=e.run("#line | text").execute();return!!this.test("stripped text",r[0],"this is a  of text")&&(r=e.run("#many | text").execute(),!!this.test("stripped text including buttons",r[0],"  with  buttons")&&void 0)})),e("Compact text",(function(){const e=t(he);let r=e.run("#line | text | compact").execute();return!!this.test("stripped text",r[0],"this is a of text")&&(r=e.run("#many | text | compact").execute(),!!this.test("stripped text including buttons",r[0],"with buttons")&&void 0)})),e("Trim",(function(){let e=t(he).run("#many | text | trim").execute();if(!this.test("stripped text including buttons",e[0],"with  buttons"))return!1})),e("Join",(function(){const e=t(he);let r=e.run("#line | #many | text | compact | join").execute();return!!this.test("joined list",r,"this is a of text, with buttons")&&(r=e.run('#line | #many | text | compact | join " - "').execute(),!!this.test("joined list custom delimeter",r,"this is a of text - with buttons")&&void 0)}))})(ee,pe),ue.run()}]);